# 合併查詢(Join Query)
- 說明：
1. 合併查詢分為INNER、LEFT、RIGHT、FULL和CROSS JOIN的內部、外部和交叉合併查詢
2. 合併查詢是將儲存在多個資料表的欄位資料取出， 使用合併條件合併成所需的查詢結果。

# 內部合併查詢
- 說明：
1. 查詢只取回多個資料表符合合併 條件的記錄資料
2. 通常是使用資料庫關聯性的外來鍵。
- 語法：
```
SELECT 欄位清單
FROM 資料表1 [INNER] JOIN 資料表2
ON 合併條件1
[ [INNER] JOIN 資料表3
ON 合併條件2]
```

- 範例:
1. 範例1:使用內部合併查詢從【學生】資料表取出學號與姓名欄位，【班級】資料表取出課程編號與教授編號欄位來顯示學生的上課資料，合併條件的欄位是學號
```
SELECT 學生.學號,學生.姓名,班級.課程編號,班級.教授編號 FROM 學生 INNER JOIN 班級
ON 學生.學號 = 班級.學號
```

2. 範例2:範例1再加上課程編號的合併
SELECT 學生.學號,學生.姓名,課程.*,班級.教授編號 FROM 課程 INNER JOIN
(學生 INNER JOIN 班級 ON 學生.學號 = 班級.學號) ON 班級.課程編號 = 課程.課程編號

3. 範例3:範例2再加上教授的合併
```
SELECT 學生.學號, 學生.姓名, 課程.*, 教授.* FROM 教授 INNER JOIN
(課程 INNER JOIN
(學生 INNER JOIN 班級 ON 學生.學號 = 班級.學號) ON 班級.課程編號 = 課程.課程編號)
ON 班級.教授編號 = 教授.教授編號
```

4. 範例4:不需要INNERJOIN指 令，只需在WHERE子句指定合併條件，也稱為 自然合併查詢。
```
SELECT 學生.學號,學生.姓名,班級.課程編號,班級.教授編號 FROM 學生, 班級
WHERE 學生.學號 = 班級.學號
```

- 相互關聯名稱
1. 說明:是在FROM 子句指定資料表的暫時名稱，可以用來簡化複雜 且容易混淆的欄位名稱。
2. 基本語法：
```
SELECT 欄位清單
FROM 資料表1 [AS] 別名1
[INNER] JOIN 資料表2 [AS] 別名2
ON 別名1.欄位名稱 運算子 別名2.欄位名稱
[[INNER] JOIN 資料表3 [AS] 別名3
ON 別名2.欄位名稱 運算子 別名3.欄位名稱]
```
3. 範例：
使用內部合併查詢從【學生】資料表取出學號與姓名欄位，和從【班級】資料表取出課程編號與教授編號欄位來顯示學生的上課資料，合併條件 是學號欄位，並且指定【班級】資料表的別名為 【上課】
```
SELECT 學生.學號,學生.姓名,上課.課程編號,上課.教授編號 FROM 學生 INNER JOIN 班級 AS 上課
ON 學生.學號 = 上課.學號
```

- 自身合併查詢
1. 說明：
(a)屬於內部合併查詢的一種特殊情況，因為合併的資料表就是自己，所以需要使用前述相互關聯名稱來指定資料表別名。
(b)自身合併查詢通常需要使用DISTINCT 關鍵字來刪除重複欄位值的記錄資料。

2. 範例:使用自身合併查詢從【員工】資料表找出同一個城巿有其他員工存在的清單

```
SELECT DISTINCT 員工.姓名, 員工.城市, 員工.街道
FROM 員工 INNER JOIN 員工 AS 員工1
ON ( 員工.城市 = 員工1.城市 AND
員工.身份證字號 <> 員工1.身份證字號 )
ORDER BY 員工.城市
```

# 外部合併查詢
1. 說明:可以取回指定資料表的所有記錄，它和內部合併查詢的差異在於:查詢結果並不是 兩個資料表都一定存在的記錄。
2. 外部指令可分成三種
- 左外部合併(LEFT JOIN):取回左邊資料 表內的所有記錄
- 右外部合併(RIGHT JOIN):取回右邊資 料表內的所有記錄
- 完全外部合併(FULL JOIN):取回左、右邊資料表內的所有記錄

3. 左外部合併查詢
- 範例:使用左外部合併查詢來查詢【教授】和【員工】 資料表，合併條件的欄位是身份證字號，可以顯 示【教授】資料表的所有記錄，左邊是教授，右邊是員工，此範例為左邊所以是以教授做合併
```
SELECT 教授.教授編號, 員工.姓名, 教授.職稱, 員工.薪水 FROM 教授 LEFT JOIN 員工
ON 教授.身份證字號 = 員工.身份證字號
```

4. 右外部合併查詢
- 範例:與左外部合併查詢範例一樣，差別在於是以員工做合併
```
SELECT 教授.教授編號, 員工.姓名, 教授.職稱, 員工.薪水 FROM 教授 RIGHT JOIN 員工
ON 教授.身份證字號 = 員工.身份證字號
```

5. 完全外部合併查詢
- 範例:將左右的資料表都取回
```
SELECT 教授.教授編號, 員工.姓名, 教授.職稱, 員工.薪水 FROM 教授 FULL JOIN 員工
ON 教授.身份證字號 = 員工.身份證字號
```

# 交叉合併查詢
- 說明:
1. 交叉合併查詢就是關聯式代數的卡笛生乘 積運算，查詢結 果的記錄數是兩個資料表記錄數的乘積。
2. 如果兩個資料表的記錄數分別是5和4筆記錄，執行交叉合併查詢後的記錄數就是5 X 4 = 20筆記錄。
- 範例1:
使用交叉合併查詢從【學生】資料表取出學號與 姓名欄位，和【班級】資料表的課程編號與教授 編號欄位
```
SELECT 學生.學號,學生.姓名,班級.課程編號,班級.教授編號 FROM 學生 CROSS JOIN 班級
```
- 範例2:使用交叉合併查詢配合WHERE子句，找出 【學生】和【班級】資料表各位學生的上課記錄，條件是兩個資料表的學號相等
```
SELECT 學生.學號, 學生.姓名, 班級.課程編號, 班級.教授編號
FROM 學生 CROSS JOIN 班級 WHERE 學生.學號 = 班級.學號
```


# 集合運算查詢(Set Operation Query)
1. UNION
- 說明：將兩個資料表的記錄都全部結合在 一起，如果有重複記錄，只顯示其中一筆，如果 加上ALL關鍵字，就會顯示所有重複的記錄
- 基本語法：
```
SELECT 欄位清單 FROM 資料表1
UNION [ALL]
SELECT 欄位清單 FROM 資料表2
[UNION [ALL] SELECT 欄位清單 FROM 資料表3 ]
[ORDER BY 欄位清單]
```
- 範例:將【學生】和【員工】兩個資料表的【姓名】欄 位，使用聯集運算取出所有學生和員工姓名
```
SELECT 姓名 FROM 學生 UNION
SELECT 姓名 FROM 員工
```
2. INTERSECT
- 說明：從兩個資料表取出同時存在 的記錄
- 基本語法：
```
SELECT 欄位清單 FROM 資料表1 INTERSECT
SELECT 欄位清單 FROM 資料表2 [ORDER BY 欄位清單]
```
- 範例:
將【學生】和【員工】兩個資料表的【姓名】欄 位使用交集運算取出存在兩個資料表的學生和員 工姓名
```
SELECT 姓名 FROM 學生 INTERSECT
SELECT 姓名 FROM 員工
```
3. EXCEPT
- 說明：只取出存在第1列SELECT指令的記錄，但是不存在第2列SELECT指令的記錄
- 基本語法：
```
SELECT 欄位清單 FROM 資料表1 EXCEPT
SELECT 欄位清單 FROM 資料表2 [ORDER BY 欄位清單]
```
- 範例：
將【學生】和【員工】兩個資料表的【姓名】欄 位使用差集運算取出存在【學生】資料表，但不 存在【員工】資料表的姓名資料
```
SELECT 姓名 FROM 學生 EXCEPT
SELECT 姓名 FROM 員工
```
# 子查詢(Subquery)
- 說明：
1. 子查詢(Subquery)也屬於多資料表的查詢，指在SELECT指令中擁有其他SELECT指令，也稱為巢狀查詢(Nested Query)。
2. 先處理子查詢，然後才依子查詢的條件來處理主查詢
3. 通常是位在主查 詢SELECT指令的WHERE子句，以便透過子查詢 取得所需的查詢條件

- FROM子句的子查詢:
範例:使用【員工】資料表的子查詢來建立FROM子句 名為【高薪員工】的暫存資料表，然後顯示【高 薪員工】資料表的記錄資料
```
SELECT 高薪員工.姓名, 高薪員工.電話, 高薪員工.薪水 FROM (SELECT 身份證字號, 姓名, 電話, 薪水
FROM 員工
WHERE 薪水>50000) AS 高薪員工
```

- 比較運算子的子查詢
1. 範例1：在【學生】資料表使用姓名欄位取得學號後，查詢【班級】資料表的學生陳會安共上幾門課
```
SELECT COUNT(*) AS 上課數 FROM 班級 
WHERE 學號 =
(SELECT 學號 FROM 學生 WHERE 姓名='陳會安')
```

2. 範例2:在【員工】資料表找出員工薪水高於平均薪水的員工資料
```
SELECT 身份證字號, 姓名, 電話, 薪水 FROM 員工 WHERE 薪水 >=
(SELECT AVG(薪水) FROM 員工)
```

- 邏輯運算子的子查詢
1. EXISTS運算子
(a)範例1:在【學生】資料表顯示【班級】資料表有上
CS222課程編號的學生資料
```
SELECT * FROM 學生
WHERE EXISTS
(SELECT * FROM 班級 WHERE 課程編號 = 'CS222'
AND 學生.學號 = 班級.學號)
```
(b)範例2:從【班級】和【課程】資料表取出所有在221-S
和100-M教室上課的課程資料
>法1
```
SELECT * FROM 課程
WHERE EXISTS
(SELECT * FROM 班級
WHERE (教室='221-S' OR 教室='100-M')
AND 課程.課程編號=班級.課程編號)
```
>法2
```
SELECT DISTINCT 課程.* FROM 課程, 班級 WHERE (班級.教室='221-S' OR 班級.教室='100-M')
AND 課程.課程編號=班級.課程編號
```

2. IN運算子
(a)範例1:從【課程】和【班級】資料表取出學號S004沒有上的課程清單
```
SELECT * FROM 課程
WHERE 課程編號 NOT IN
(SELECT 課程編號 FROM 班級 WHERE 學號='S004')
```
(b)範例2:使用三層巢狀查詢從【學生】、【班級】和【教授】資料表，找出學生【江小魚】上了哪些教授的哪些課程
```
SELECT * FROM 教授 
WHERE 教授編號 IN
(SELECT 教授編號 FROM 班級
WHERE 學號=(SELECT 學號 FROM 學生
 WHERE 姓名='江小魚'))
```
3. ALL運算子
範例：使用子查詢取出【員工】資料表城巿是台北的薪水資料，然後在父查詢查詢所有薪水大於等於子查詢薪水的記錄資料，也就是要比居住在台北的最高薪水還高或等於的才列出。
```
SELECT 姓名, 薪水 FROM 員工
WHERE 薪水 >= ALL
(SELECT 薪水 FROM 員工 WHERE 城市='台北')
```

4. ANY和SOME運算子
> 備註：ANY和SOME一樣
範例：只要比城市在台北中最低薪水高都會列出來
```
SELECT 姓名, 薪水 FROM 員工
WHERE 薪水 >= ANY
(SELECT 薪水 FROM 員工 WHERE 城市='台北')
```

# OFFSET
- 說明：可以指定位移幾筆記錄來開始傳回查詢結果

- 語法：
```
OFFSET 整數常數或運算式 ROW | ROWS
```
>備註：ROW | ROWS沒差

- 範例:查詢【員工】資料表的員工記錄並且位移3筆，傳回第4筆之後的員工資料
```
SELECT 身份證字號, 姓名, 薪水 FROM 員工
ORDER BY 身份證字號 OFFSET 3 ROWS
```

# FETCH NEXT
- 說明：是位在OFFSET子句之後，可以指定傳回位移之後的幾筆記錄
- 語法：
```
FETCH FIRST | NEXT 整數常數或運算式 ROW | ROWS ONLY
```
>備註：FIRST和NEXT是同義詞

- 範例:請查詢【員工】資料表的員工記錄，在位移3筆後，
傳回第4筆開始的5筆員工資料
```
SELECT 身份證字號, 姓名, 薪水
FROM 員工
ORDER BY 身份證字號
OFFSET 3 ROWS
FETCH NEXT 5 ROWS ONLY
```

# NULL空值的處理
- 說明：可以使用```IS NULL```運算式和欄位值 進行比較
- 語法：
```
ISNULL(檢查運算式, 替代值)
```
>檢查運算式是否為 NULL空值，如果是，就以替代值輸出
>函數的兩個參數類型需相同，如果不同，請使用 CAST(欄位名稱 AS 類型)函數來進行轉換

- 範例:
1. 範例1:查詢【學生】資料表沒有生日資料的學生記錄，
 即生日欄位是空值的記錄資料:
 ```
 SELECT * FROM 學生 WHERE 生日 IS NULL
 ```

2. 範例2:查詢【員工】資料表的電話欄位如果是空
值，就輸出成'無電話
```
SELECT 身份證字號, 姓名,
ISNULL(電話, '無電話') AS 電話 FROM 員工
```

# CTE一般資料表運算式
- 說明：
CTE(CommonTableExpression)一般資料表 運算式可以預先建立一至多個暫存資料表，以便 在之後的SELECT查詢使用，或是建立遞迴查詢。
- 語法：
```
WITH 暫存資料表名稱1 [(欄位名稱清單)]
AS (
SELECT指令敘述
)
[, 暫存資料表名稱2 [(欄位名稱清單)] AS (SELECT指令敘述)
] .....
```
- 範例1:使用CTE建立名為【教授_員工】的暫存資料表後，使用 此暫存資料表來執行內部合併查詢，可以顯示學生的上課 資料
```
WITH 教授_員工
AS ( SELECT 教授.*, 員工.姓名
FROM 教授 INNER JOIN 員工
ON 教授.身份證字號 = 員工.身份證字號 )
SELECT 學生.學號, 學生.姓名, 課程.*, 教授_員工.* FROM 教授_員工 INNER JOIN (課程 INNER JOIN
(學生 INNER JOIN 班級 ON 學生.學號 = 班級.學號)
ON 班級.課程編號 = 課程.課程編號)
ON 班級.教授編號 = 教授_員工.教授編號
```

- 範例2:使用遞迴CTE建立【主管】資料表的遞迴查詢，可以顯示
 每位員工其上層主管的階層數
 ```
 WITH 主管_遞迴
AS ( SELECT 員工字號, 姓名, 1 AS 階層 FROM 主管 WHERE 主管字號 IS NULL UNION ALL
SELECT 主管.員工字號, 主管.姓名, 階層+1 FROM 主管 JOIN 主管_遞迴
ON 主管.主管字號 = 主管_遞迴.員工字號 ) SELECT * FROM 主管_遞迴
ORDER BY 階層, 員工字號
 ```





